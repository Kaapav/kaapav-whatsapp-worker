<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kaapav â€” WhatsApp Admin (Static Shell)</title>
  <style>
    :root{--gold:#B88B2F;--gold-dark:#8A6320;--white:#FFFFFF;--paper:#FFF8F0;--text:#2B241E}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--paper);color:var(--text)}
    /* Scoped reset for isolation */
    .k-root{height:100vh;display:flex;flex-direction:column}
    .k-header{height:64px;background:linear-gradient(180deg,var(--gold),var(--gold-dark));color:var(--white);display:flex;align-items:center;gap:12px;padding:0 16px;box-shadow:0 4px 18px rgba(0,0,0,0.08);}
    .k-h-left{display:flex;align-items:center;gap:12px}
    .k-menu-btn{background:transparent;border:none;color:var(--white);font-size:22px;cursor:pointer}
    .k-brand{font-weight:700;font-size:18px}
    .k-status{margin-left:auto;background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-size:13px}

    .k-body{flex:1;display:grid;grid-template-columns:320px 1fr 360px;min-height:0;gap:12px;padding:12px}

    /* left sidebar */
    .k-sidebar{background:var(--white);border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.03);transition:width .22s ease}
    .k-sidebar.collapsed{width:54px}
    .k-search{padding:12px;border-bottom:1px solid #f0e1c6;display:flex;gap:8px;align-items:center}
    .k-search input{flex:1;padding:10px;border-radius:999px;border:1px solid #f0e1c6}
    .k-sessions{overflow:auto;height:calc(100% - 68px)}
    .k-session{display:flex;gap:10px;padding:12px;align-items:center;border-bottom:1px solid rgba(0,0,0,0.02);cursor:pointer}
    .k-session:hover{background:#FFF8EB}
    .k-avatar{width:44px;height:44;border-radius:8px;background:#FFF3DF;display:grid;place-items:center;font-weight:700}

    /* center chat */
    .k-chat{display:flex;flex-direction:column;border-radius:12px;overflow:hidden;box-shadow:0 8px 34px rgba(0,0,0,0.06);}
    .k-chat-head{display:flex;align-items:center;gap:12px;padding:12px;background:var(--white);border-bottom:1px solid #f0e1c6}
    .k-chat-body{flex:1;overflow:auto;padding:18px;background:linear-gradient(180deg,#fff,#FFF8F4)}
    .k-bubble{display:inline-block;padding:10px 14px;border-radius:14px;max-width:72%;margin-bottom:8px}
    .k-in{background:var(--white);border:1px solid #f0e1c6;color:var(--text)}
    .k-out{background:linear-gradient(180deg,var(--gold),var(--gold-dark));color:var(--white);margin-left:auto}
    .k-compose{display:flex;gap:8px;padding:12px;background:var(--white);border-top:1px solid #f0e1c6;align-items:center}
    .k-compose textarea{flex:1;padding:10px;border-radius:999px;border:1px solid #f0e1c6;resize:none}
    .k-compose button{background:var(--gold);color:var(--white);border:none;padding:10px 12px;border-radius:999px;cursor:pointer}

    /* right log / actions */
    .k-right{background:var(--white);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.03);overflow:auto}
    .k-logitem{padding:10px;border-bottom:1px dashed #f0e1c6}

    /* auto-hide hit area */
    .k-left-hit{position:fixed;left:0;top:64px;width:18px;bottom:12px;z-index:40}

    /* menu drawer (left full) */
    .k-drawer{position:fixed;left:12px;top:76px;width:280px;background:var(--white);border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.12);padding:12px;z-index:50;display:none}
    .k-drawer.open{display:block}
    .k-drawer .opt{padding:10px;border-radius:8px;cursor:pointer}
    .k-drawer .opt:hover{background:#FFF8EC}

    /* responsive */
    @media (max-width:1000px){.k-body{grid-template-columns:1fr}.k-right{display:none}.k-sidebar{position:fixed;left:12px;top:76px;bottom:12px;z-index:60}}
  </style>
</head>
<body>
  <div class="k-root">
    <header class="k-header">
      <div class="k-h-left">
        <button id="hamburger" class="k-menu-btn">â˜°</button>
        <div class="k-brand">Kaapav Chats</div>
      </div>
      <div id="status" class="k-status">Offline</div>
    </header>

    <div class="k-body">
      <aside id="sidebar" class="k-sidebar">
        <div class="k-search"><input id="search" placeholder="Search or start new chat"/></div>
        <div id="sessions" class="k-sessions"></div>
      </aside>

      <main class="k-chat">
        <div class="k-chat-head"><div id="chatTitle">Select a conversation</div></div>
        <div id="messages" class="k-chat-body"></div>
        <div class="k-compose">
          <input id="file" type="file" style="display:none" />
          <label for="file" style="cursor:pointer">ðŸ“Ž</label>
          <textarea id="composer" rows="1" placeholder="Type a message" disabled></textarea>
          <button id="send">âž¤</button>
        </div>
      </main>

      <aside id="right" class="k-right">
        <div style="font-weight:700;margin-bottom:8px">Live Log â€” +91 48330016</div>
        <div id="log"></div>
      </aside>

      <div id="leftHit" class="k-left-hit" aria-hidden="true"></div>
    </div>

    <div id="drawer" class="k-drawer" role="menu" aria-hidden="true">
      <div class="opt" data-action="chats">Chats</div>
      <div class="opt" data-action="catalogue">Catalogue</div>
      <div class="opt" data-action="pay">Pay</div>
      <div class="opt" data-action="ship">Ship</div>
      <div class="opt" data-action="broadcast">Broadcast</div>
      <div class="opt" data-action="settings">Settings</div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    (function(){
      // Config
      const BUSINESS_LOCAL = '9148330016';
      const SOCKET_URL = window.__SOCKET_URL__ || (location.origin + '/socket.io');
      const API_BASE = window.__API_BASE__ || (location.origin + '/api');
      const ADMIN_TOKEN = localStorage.getItem('ADMIN_TOKEN') || '';

      // UI refs
      const sidebar = document.getElementById('sidebar');
      const sessionsEl = document.getElementById('sessions');
      const messagesEl = document.getElementById('messages');
      const logEl = document.getElementById('log');
      const composer = document.getElementById('composer');
      const sendBtn = document.getElementById('send');
      const statusEl = document.getElementById('status');
      const drawer = document.getElementById('drawer');
      const hamburger = document.getElementById('hamburger');
      const leftHit = document.getElementById('leftHit');

      // State
      let socket = null;
      let sessions = [];
      let selected = null;
      let hideTimer = null;

      // Helpers
      function showToast(t){ console.log('TOAST',t); }
      function formatTime(ts){ const d=new Date(ts||Date.now()); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

      function renderSessions(){
        sessionsEl.innerHTML='';
        if(!sessions.length){ sessionsEl.innerHTML='<div style="padding:12px;color:#666">No sessions</div>'; return }
        sessions.forEach(s=>{
          const el=document.createElement('div'); el.className='k-session';
          el.innerHTML=`<div class='k-avatar'>${(s.name||s.userId||'U').slice(0,1).toUpperCase()}</div><div style='flex:1;min-width:0'><div style='font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis'>${s.name||s.userId}</div><div style='font-size:12px;color:#8a8175;white-space:nowrap;overflow:hidden;text-overflow:ellipsis'>${s.lastMessage||''}</div></div>`;
          el.addEventListener('click',()=>selectSession(s.userId));
          sessionsEl.appendChild(el);
        })
      }

      function appendMessage(m){
        const wrap=document.createElement('div');
        const isOut = (m.direction==='out' || m.from==='admin');
        const bubble=document.createElement('div'); bubble.className = 'k-bubble ' + (isOut? 'k-out':'k-in');
        const meta=document.createElement('div'); meta.style.fontSize='12px'; meta.style.color=isOut? 'rgba(255,255,255,0.9)':'#8a8175'; meta.style.marginBottom='6px'; meta.textContent = (isOut? 'You' : (m.from||'User')) + ' â€¢ ' + formatTime(m.ts);
        const body=document.createElement('div'); body.textContent = m.text||m.message||'';
        bubble.appendChild(meta); bubble.appendChild(body);
        wrap.appendChild(bubble); messagesEl.appendChild(wrap); messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function addLog(item){ const d=document.createElement('div'); d.className='k-logitem'; d.innerHTML = `<div style="font-size:12px;color:#888">${formatTime(item.ts)}</div><div style="font-weight:600">${item.from}</div><div style="margin-top:6px">${item.txt}</div>`; logEl.prepend(d); if(logEl.children.length>80) logEl.removeChild(logEl.lastChild); }

      function selectSession(id){ selected=id; messagesEl.innerHTML=''; composer.disabled=false; sendBtn.disabled=false; document.getElementById('chatTitle').textContent = id; 
        // fetch history
        fetch(`${API_BASE}/messages/history?user=${encodeURIComponent(id)}`,{headers: ADMIN_TOKEN?{Authorization:'Bearer '+ADMIN_TOKEN}:{} }).then(r=>r.json()).then(list=>{ (list||[]).forEach(m=>appendMessage(m)); messagesEl.scrollTop = messagesEl.scrollHeight }).catch(()=>{});
        // auto-hide like WA
        if(window.innerWidth>900) sidebar.classList.add('collapsed');
      }

      // auto-hide logic
      leftHit.addEventListener('mouseenter', ()=>{ clearTimeout(hideTimer); sidebar.classList.remove('collapsed'); });
      sidebar.addEventListener('mouseleave', ()=>{ clearTimeout(hideTimer); hideTimer=setTimeout(()=>sidebar.classList.add('collapsed'),900); });

      // drawer menu
      hamburger.addEventListener('click',()=>{ drawer.classList.toggle('open'); });
      drawer.addEventListener('click',(e)=>{
        const act = e.target.getAttribute('data-action'); if(!act) return;
        drawer.classList.remove('open');
        if(act==='chats'){ sidebar.classList.remove('collapsed'); }
        if(act==='catalogue'){ openAction('catalogue'); }
        if(act==='pay'){ openAction('pay'); }
        if(act==='ship'){ openAction('ship'); }
        if(act==='broadcast'){ openAction('broadcast'); }
      });

      function openAction(name){ // open right action panel (simple log for static)
        addLog({ts:Date.now(), from:'SYSTEM', txt:`Open action: ${name}`});
        // In integration phase, this will open the full action UI
      }

      // send
      sendBtn.addEventListener('click', ()=>{ const text = composer.value.trim(); if(!text || !selected) return; const payload = { to: selected, text }; appendMessage({ ...payload, from:'admin', direction:'out', ts:Date.now() }); composer.value=''; try{ socket && socket.connected && socket.emit('admin_send_message', payload); }catch(e){} fetch(`${API_BASE}/messages/send`,{method:'POST',headers:{'Content-Type':'application/json', ...(ADMIN_TOKEN?{Authorization:'Bearer '+ADMIN_TOKEN}:{})},body:JSON.stringify(payload)}).catch(()=>{}); });

      // quick seed
      sessions = [{userId:'919812345678',name:'Sujata',lastMessage:'Is the bracelet in stock?'},{userId:'919700111222',name:'Rahul',lastMessage:'Order status?'},{userId:BUSINESS_LOCAL,name:'Kaapav Admin',lastMessage:'System ready'}]; renderSessions();

      // socket
      try{
        socket = io(SOCKET_URL, { auth: { token: ADMIN_TOKEN }, transports:['websocket','polling'] });
        socket.on('connect', ()=>{ statusEl.textContent='Online'; statusEl.style.background='rgba(255,255,255,0.12)'; showToast('Socket connected'); });
        socket.on('disconnect', ()=>{ statusEl.textContent='Offline'; statusEl.style.background=''; showToast('Socket disconnected'); });
        socket.on('sessions_snapshot', list=>{ sessions = Array.isArray(list)?list:sessions; renderSessions(); });
        socket.on('session_messages', list=>{ messagesEl.innerHTML=''; (list||[]).forEach(m=>appendMessage(m)); });
        socket.on('incoming_message', m=>{ const msg = { id: m.id||('i_'+Date.now()), from:m.from, to:m.to, text:m.text||m.message||'', ts:m.ts||Date.now(), direction:'in' }; appendMessage(msg); if((msg.to||'').replace(/\D/g,'')===BUSINESS_LOCAL){ showToast(`Incoming from ${msg.from}: "${(msg.text||'').slice(0,40)}"`); addLog({ts:msg.ts,from:msg.from,txt:msg.text}); } });
        socket.on('outgoing_message', m=>{ appendMessage({ ...m, direction:'out' }); });

        // request snapshot
        socket.emit && socket.emit('request_sessions_snapshot');
      }catch(e){ console.warn('socket fail',e); }

      // expose test helper
      window._testIncoming = function(from,text){ const m={from,to:BUSINESS_LOCAL,text,ts:Date.now()}; appendMessage({ ...m, direction:'in' }); addLog({ts:m.ts,from:m.from,txt:m.text}); };

    })();
  </script>
<!-- socket.io client (keep this before the inline script) -->
<script src="https://cdn.socket.io/4.8.1/socket.io.min.js" crossorigin="anonymous"></script>

<script>
(function(){
  // ---------- CONFIG ----------
  // Prefer explicit host/path globals if you set them earlier:
  // window.__SOCKET_HOST__ = 'https://crm.kaapav.com'   // optional
  // window.__SOCKET_PATH__ = '/socket.io'              // optional
  // window.__API_BASE__ = 'https://crm.kaapav.com/api'  // optional
  const ADMIN_TOKEN = localStorage.getItem('ADMIN_TOKEN') || (function(){ const t = prompt('ADMIN_TOKEN (paste)'); if(t) localStorage.setItem('ADMIN_TOKEN', t); return t; })();
  if(!ADMIN_TOKEN){
    console.error('ADMIN_TOKEN missing â€” aborting socket connect');
    const sEl = document.getElementById('status'); if(sEl) sEl.textContent = 'Offline â€” no token';
    return;
  }

  const SOCKET_HOST = (typeof window.__SOCKET_HOST__ !== 'undefined') ? window.__SOCKET_HOST__ : window.location.origin;
  const SOCKET_PATH = (typeof window.__SOCKET_PATH__ !== 'undefined') ? window.__SOCKET_PATH__ : undefined;
  const API_BASE = (typeof window.__API_BASE__ !== 'undefined') ? window.__API_BASE__ : (window.location.origin + '/api');

  const socketOpts = { transports: ['websocket','polling'], auth: { token: ADMIN_TOKEN } };
  if(SOCKET_PATH) socketOpts.path = SOCKET_PATH;

  // ---------- INIT SOCKET ----------
  let socket;
  try {
    socket = io(SOCKET_HOST, socketOpts);
  } catch (e) {
    console.error('socket.io init failed', e);
    const sEl = document.getElementById('status'); if(sEl) sEl.textContent = 'Socket init failed';
    return;
  }

  // ---------- UI ADAPTERS (non-invasive) ----------
  // Prefer user-provided helpers if present (so we DON'T change your UI)
  const hasAppend = (typeof window.appendMessage === 'function');
  const hasRenderSessions = (typeof window.renderSessions === 'function');

  function safeAppend(msg){
    try{
      if(hasAppend) { window.appendMessage(msg); return; }
    }catch(e){ console.warn('user appendMessage failed', e); }
    // fallback minimal DOM append if no appendMessage provided
    const msgsEl = document.getElementById('messages') || document.body;
    const wrap = document.createElement('div');
    wrap.style.padding = '8px'; wrap.style.borderBottom = '1px solid #eee';
    const who = document.createElement('div'); who.style.fontWeight='700'; who.textContent = msgDisplayName(msg);
    const body = document.createElement('div'); body.textContent = msgText(msg);
    const meta = document.createElement('div'); meta.style.fontSize='12px'; meta.style.color='#666'; meta.textContent = new Date(msg.ts||Date.now()).toLocaleTimeString();
    wrap.appendChild(who); wrap.appendChild(body); wrap.appendChild(meta);
    msgsEl.appendChild(wrap);
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  function msgText(m){
    if(!m) return '';
    return m.text || (m.message && (m.message.text || m.message.body)) || m.body || '';
  }
  function msgDisplayName(m){
    if(!m) return 'unknown';
    return m.from || m.name || m.session || 'unknown';
  }

  function normalize(m){
    if(!m) return { id: 'm_' + Date.now(), from: 'unknown', text: '', ts: Date.now(), direction: 'in', raw: m };
    const text = msgText(m);
    const from = m.from || m.fromNumber || m.sender || (m.message && m.message.from) || (m.session) || 'unknown';
    const ts = m.ts || m.timestamp || Date.now();
    const id = m.id || m._id || ('m_' + ts);
    const direction = m.direction || (m.outgoing ? 'out' : (m.from && (String(m.from).includes('admin') ? 'out' : 'in'))) ;
    return { id, from, text, ts, direction, raw: m };
  }

  function appendNormalized(m){ safeAppend(normalize(m)); }

  // ---------- CONNECTION / EVENTS ----------
  const statusEl = document.getElementById('status');
  function setStatus(txt, bg){ if(statusEl){ statusEl.textContent = txt; statusEl.style.background = bg || ''; } }

  socket.on('connect', () => {
    setStatus('Online', 'rgba(255,255,255,0.12)');
    console.log('socket connected', socket.id);
    // ask for sessions using multiple common event names (compatibility)
    ['admin_request_sessions','request_sessions','request_sessions_snapshot','request_sessions_list','get_sessions'].forEach(ev => {
      try{ socket.emit(ev); }catch(e){}
    });
    // also emit a fallback snapshot request
    try{ socket.emit('request_sessions_snapshot'); }catch(e){}
  });

  socket.on('disconnect', (reason) => {
    setStatus('Offline', '');
    console.warn('socket disconnected', reason);
  });

  socket.on('connect_error', (err) => {
    setStatus('Socket error', 'crimson');
    console.error('socket connect_error', err && err.message ? err.message : err);
  });

  // common server events -> normalize + append
  const incomingEventNames = ['incoming_message','new_message','message','message.in','message_received'];
  incomingEventNames.forEach(ev => {
    socket.on(ev, payload => {
      if(Array.isArray(payload)) payload.forEach(p => appendNormalized(p));
      else appendNormalized(payload);
    });
  });

  socket.on('outgoing_message', (payload) => {
    if(Array.isArray(payload)) payload.forEach(p => appendNormalized(Object.assign({}, p, { direction:'out' })));
    else appendNormalized(Object.assign({}, payload, { direction:'out' }));
  });

  socket.on('sessions_snapshot', (snap) => {
    try{
      if(hasRenderSessions){ window.renderSessions(snap); return; }
    }catch(e){ console.warn('renderSessions failed', e); }
    // fallback: render session summaries into messages list (non-destructive)
    if(Array.isArray(snap)) snap.slice(0,50).forEach(s => {
      const last = s.lastMessage || s.last || (s.messages && s.messages[0]) || {};
      appendNormalized({ from: s.name || s.session || s.id, text: last.text || last.body || '', ts: last.ts || Date.now() });
    });
  });

  socket.on('session_messages', (list) => {
    // server may send array of messages or { messages: [...] }
    let arr = [];
    if(Array.isArray(list)) arr = list;
    else if(list && Array.isArray(list.messages)) arr = list.messages;
    // if user has appendMessage, try to use it in order (oldest -> newest)
    if(hasAppend){
      try{ arr.forEach(m => window.appendMessage(m)); return; }catch(e){ console.warn('appendMessage failed for session_messages', e); }
    }
    arr.forEach(m => appendNormalized(m));
  });

  // log unexpected events lightly
  socket.onAny((ev, data) => {
    if(['heartbeat','typing'].includes(ev)) return;
    console.debug('socket event ->', ev);
  });

  // ---------- SENDER (exposed) ----------
  window.sendAdminMessage = function(to, text, cb){
    if(!to || !text) return cb && cb({ error: 'to/text required' });
    const payload = { to, text };
    // prefer socket if connected
    if(socket && socket.connected){
      socket.emit('admin_send_message', payload, (ack) => {
        if(ack && ack.error){ console.error('send ack error', ack); cb && cb(ack); return; }
        appendNormalized({ from: 'You', to, text, ts: Date.now(), direction: 'out' });
        cb && cb(null, ack || { ok: true });
      });
      // legacy event names for compatibility
      socket.emit('send_message', payload);
      socket.emit('message_to', payload);
      return;
    }
    // fallback HTTP send if socket not connected
    fetch(API_BASE + '/messages/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ADMIN_TOKEN },
      body: JSON.stringify(payload)
    }).then(r => r.json()).then(res => {
      appendNormalized({ from: 'You', to, text, ts: Date.now(), direction: 'out' });
      cb && cb(null, res);
    }).catch(err => { cb && cb(err); });
  };

  // ---------- POLL FALLBACK (if socket doesn't connect) ----------
  let pollTimer = null;
  const startPoll = () => {
    if(pollTimer) return;
    pollTimer = setInterval(() => {
      fetch(API_BASE + '/admin/sessions', { headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN } })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(json => { if(hasRenderSessions) try{ window.renderSessions(json); }catch(e){ console.warn(e); } })
        .catch(()=>{/* silent */});
    }, 5000);
  };
  setTimeout(()=>{ if(!socket.connected) startPoll(); }, 5000);

  // expose internal for debugging
  window.__kaapavSocket = socket;

  console.log('Socket shell initialized (ADMIN_TOKEN present). Host:', SOCKET_HOST);
})();
</script>

</body>
</html>
